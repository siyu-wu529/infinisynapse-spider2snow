-- sf_ga001: 分析购买了Google Navy Speckled Tee的客户在2020年12月的偏好
-- 找出与Google Navy Speckled Tee一起购买数量最多的其他产品

-- 查询所有2020年12月购买事件，找出包含Google Navy Speckled Tee的交易
WITH all_december_purchases AS (
    -- 2020年12月1日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201201" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月2日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201202" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月3日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201203" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月4日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201204" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月5日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201205" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月6日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201206" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月7日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201207" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月8日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201208" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月9日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201209" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月10日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201210" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月11日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201211" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月12日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201212" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月13日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201213" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月14日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201214" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月15日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201215" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月16日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201216" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月17日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201217" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月18日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201218" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月19日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201219" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月20日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201220" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月21日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201221" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月22日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201222" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月23日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201223" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月24日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201224" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月25日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201225" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月26日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201226" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月27日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201227" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月28日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201228" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月29日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201229" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月30日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201230" WHERE EVENT_NAME = 'purchase'
    UNION ALL
    -- 2020年12月31日
    SELECT EVENT_DATE, EVENT_TIMESTAMP, USER_PSEUDO_ID, ITEMS
    FROM "EVENTS_20201231" WHERE EVENT_NAME = 'purchase'
),
navy_tee_purchases AS (
    SELECT 
        EVENT_DATE,
        EVENT_TIMESTAMP,
        USER_PSEUDO_ID,
        ITEMS
    FROM all_december_purchases
    WHERE ITEMS LIKE '%Google Navy Speckled Tee%'
),
parsed_items AS (
    SELECT 
        USER_PSEUDO_ID,
        get_json_object(item, '$.item_name') AS item_name,
        CAST(get_json_object(item, '$.quantity') AS INT) AS quantity
    FROM navy_tee_purchases
    LATERAL VIEW explode(split(regexp_replace(regexp_replace(ITEMS, '^\\[|\\]$', ''), '\\}\\,\\s*\\{', '}||{'), '\\|\\|')) items AS item
    WHERE get_json_object(item, '$.item_name') IS NOT NULL
)
-- 分析同时购买的其他产品并计算总数量
SELECT 
    item_name,
    SUM(quantity) AS total_quantity,
    COUNT(DISTINCT USER_PSEUDO_ID) AS unique_customers,
    COUNT(*) AS purchase_occurrences
FROM parsed_items
WHERE item_name != 'Google Navy Speckled Tee'
GROUP BY item_name
ORDER BY total_quantity DESC
LIMIT 20;

-- 分析结果：
-- 与Google Navy Speckled Tee一起购买数量最多的产品是"Google Sunglasses"，总购买数量为4件
-- 该产品被2个不同的客户购买，共出现了4次购买记录