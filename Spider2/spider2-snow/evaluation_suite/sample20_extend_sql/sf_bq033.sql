-- sf_bq033: 统计2008-2022年每月包含"internet of things"的美国专利数量
-- 数据源: PATENTS_PATENTS.PUBLICATIONS

-- 第一步：统计每月包含"internet of things"的美国专利数量
SELECT 
  SUBSTR(CAST(publication_date AS STRING), 1, 4) AS year,
  SUBSTR(CAST(publication_date AS STRING), 5, 2) AS month,
  COUNT(*) AS publication_count
FROM PATENTS_PATENTS_PUBLICATIONS 
WHERE country_code = 'US'
  AND publication_date BETWEEN 20080101 AND 20221231
  AND abstract_localized IS NOT NULL
  AND LOWER(CAST(abstract_localized AS STRING)) LIKE '%internet of things%'
GROUP BY year, month
ORDER BY year, month;

-- 第二步：创建包含所有月份的完整时间序列（包括没有专利的月份）
SELECT 
  am.year,
  am.month,
  am.year_month,
  COALESCE(ip.publication_count, 0) AS publication_count
FROM (
  -- 生成2008-2022年所有月份的时间序列
  SELECT '2008-01' AS year_month, 2008 AS year, 1 AS month
  UNION ALL SELECT '2008-02', 2008, 2
  UNION ALL SELECT '2008-03', 2008, 3
  UNION ALL SELECT '2008-04', 2008, 4
  UNION ALL SELECT '2008-05', 2008, 5
  UNION ALL SELECT '2008-06', 2008, 6
  UNION ALL SELECT '2008-07', 2008, 7
  UNION ALL SELECT '2008-08', 2008, 8
  UNION ALL SELECT '2008-09', 2008, 9
  UNION ALL SELECT '2008-10', 2008, 10
  UNION ALL SELECT '2008-11', 2008, 11
  UNION ALL SELECT '2008-12', 2008, 12
  UNION ALL SELECT '2009-01', 2009, 1
  UNION ALL SELECT '2009-02', 2009, 2
  UNION ALL SELECT '2009-03', 2009, 3
  UNION ALL SELECT '2009-04', 2009, 4
  UNION ALL SELECT '2009-05', 2009, 5
  UNION ALL SELECT '2009-06', 2009, 6
  UNION ALL SELECT '2009-07', 2009, 7
  UNION ALL SELECT '2009-08', 2009, 8
  UNION ALL SELECT '2009-09', 2009, 9
  UNION ALL SELECT '2009-10', 2009, 10
  UNION ALL SELECT '2009-11', 2009, 11
  UNION ALL SELECT '2009-12', 2009, 12
  UNION ALL SELECT '2010-01', 2010, 1
  UNION ALL SELECT '2010-02', 2010, 2
  UNION ALL SELECT '2010-03', 2010, 3
  UNION ALL SELECT '2010-04', 2010, 4
  UNION ALL SELECT '2010-05', 2010, 5
  UNION ALL SELECT '2010-06', 2010, 6
  UNION ALL SELECT '2010-07', 2010, 7
  UNION ALL SELECT '2010-08', 2010, 8
  UNION ALL SELECT '2010-09', 2010, 9
  UNION ALL SELECT '2010-10', 2010, 10
  UNION ALL SELECT '2010-11', 2010, 11
  UNION ALL SELECT '2010-12', 2010, 12
  UNION ALL SELECT '2011-01', 2011, 1
  UNION ALL SELECT '2011-02', 2011, 2
  UNION ALL SELECT '2011-03', 2011, 3
  UNION ALL SELECT '2011-04', 2011, 4
  UNION ALL SELECT '2011-05', 2011, 5
  UNION ALL SELECT '2011-06', 2011, 6
  UNION ALL SELECT '2011-07', 2011, 7
  UNION ALL SELECT '2011-08', 2011, 8
  UNION ALL SELECT '2011-09', 2011, 9
  UNION ALL SELECT '2011-10', 2011, 10
  UNION ALL SELECT '2011-11', 2011, 11
  UNION ALL SELECT '2011-12', 2011, 12
  UNION ALL SELECT '2012-01', 2012, 1
  UNION ALL SELECT '2012-02', 2012, 2
  UNION ALL SELECT '2012-03', 2012, 3
  UNION ALL SELECT '2012-04', 2012, 4
  UNION ALL SELECT '2012-05', 2012, 5
  UNION ALL SELECT '2012-06', 2012, 6
  UNION ALL SELECT '2012-07', 2012, 7
  UNION ALL SELECT '2012-08', 2012, 8
  UNION ALL SELECT '2012-09', 2012, 9
  UNION ALL SELECT '2012-10', 2012, 10
  UNION ALL SELECT '2012-11', 2012, 11
  UNION ALL SELECT '2012-12', 2012, 12
  UNION ALL SELECT '2013-01', 2013, 1
  UNION ALL SELECT '2013-02', 2013, 2
  UNION ALL SELECT '2013-03', 2013, 3
  UNION ALL SELECT '2013-04', 2013, 4
  UNION ALL SELECT '2013-05', 2013, 5
  UNION ALL SELECT '2013-06', 2013, 6
  UNION ALL SELECT '2013-07', 2013, 7
  UNION ALL SELECT '2013-08', 2013, 8
  UNION ALL SELECT '2013-09', 2013, 9
  UNION ALL SELECT '2013-10', 2013, 10
  UNION ALL SELECT '2013-11', 2013, 11
  UNION ALL SELECT '2013-12', 2013, 12
  UNION ALL SELECT '2014-01', 2014, 1
  UNION ALL SELECT '2014-02', 2014, 2
  UNION ALL SELECT '2014-03', 2014, 3
  UNION ALL SELECT '2014-04', 2014, 4
  UNION ALL SELECT '2014-05', 2014, 5
  UNION ALL SELECT '2014-06', 2014, 6
  UNION ALL SELECT '2014-07', 2014, 7
  UNION ALL SELECT '2014-08', 2014, 8
  UNION ALL SELECT '2014-09', 2014, 9
  UNION ALL SELECT '2014-10', 2014, 10
  UNION ALL SELECT '2014-11', 2014, 11
  UNION ALL SELECT '2014-12', 2014, 12
  UNION ALL SELECT '2015-01', 2015, 1
  UNION ALL SELECT '2015-02', 2015, 2
  UNION ALL SELECT '2015-03', 2015, 3
  UNION ALL SELECT '2015-04', 2015, 4
  UNION ALL SELECT '2015-05', 2015, 5
  UNION ALL SELECT '2015-06', 2015, 6
  UNION ALL SELECT '2015-07', 2015, 7
  UNION ALL SELECT '2015-08', 2015, 8
  UNION ALL SELECT '2015-09', 2015, 9
  UNION ALL SELECT '2015-10', 2015, 10
  UNION ALL SELECT '2015-11', 2015, 11
  UNION ALL SELECT '2015-12', 2015, 12
  UNION ALL SELECT '2016-01', 2016, 1
  UNION ALL SELECT '2016-02', 2016, 2
  UNION ALL SELECT '2016-03', 2016, 3
  UNION ALL SELECT '2016-04', 2016, 4
  UNION ALL SELECT '2016-05', 2016, 5
  UNION ALL SELECT '2016-06', 2016, 6
  UNION ALL SELECT '2016-07', 2016, 7
  UNION ALL SELECT '2016-08', 2016, 8
  UNION ALL SELECT '2016-09', 2016, 9
  UNION ALL SELECT '2016-10', 2016, 10
  UNION ALL SELECT '2016-11', 2016, 11
  UNION ALL SELECT '2016-12', 2016, 12
  UNION ALL SELECT '2017-01', 2017, 1
  UNION ALL SELECT '2017-02', 2017, 2
  UNION ALL SELECT '2017-03', 2017, 3
  UNION ALL SELECT '2017-04', 2017, 4
  UNION ALL SELECT '2017-05', 2017, 5
  UNION ALL SELECT '2017-06', 2017, 6
  UNION ALL SELECT '2017-07', 2017, 7
  UNION ALL SELECT '2017-08', 2017, 8
  UNION ALL SELECT '2017-09', 2017, 9
  UNION ALL SELECT '2017-10', 2017, 10
  UNION ALL SELECT '2017-11', 2017, 11
  UNION ALL SELECT '2017-12', 2017, 12
  UNION ALL SELECT '2018-01', 2018, 1
  UNION ALL SELECT '2018-02', 2018, 2
  UNION ALL SELECT '2018-03', 2018, 3
  UNION ALL SELECT '2018-04', 2018, 4
  UNION ALL SELECT '2018-05', 2018, 5
  UNION ALL SELECT '2018-06', 2018, 6
  UNION ALL SELECT '2018-07', 2018, 7
  UNION ALL SELECT '2018-08', 2018, 8
  UNION ALL SELECT '2018-09', 2018, 9
  UNION ALL SELECT '2018-10', 2018, 10
  UNION ALL SELECT '2018-11', 2018, 11
  UNION ALL SELECT '2018-12', 2018, 12
  UNION ALL SELECT '2019-01', 2019, 1
  UNION ALL SELECT '2019-02', 2019, 2
  UNION ALL SELECT '2019-03', 2019, 3
  UNION ALL SELECT '2019-04', 2019, 4
  UNION ALL SELECT '2019-05', 2019, 5
  UNION ALL SELECT '2019-06', 2019, 6
  UNION ALL SELECT '2019-07', 2019, 7
  UNION ALL SELECT '2019-08', 2019, 8
  UNION ALL SELECT '2019-09', 2019, 9
  UNION ALL SELECT '2019-10', 2019, 10
  UNION ALL SELECT '2019-11', 2019, 11
  UNION ALL SELECT '2019-12', 2019, 12
  UNION ALL SELECT '2020-01', 2020, 1
  UNION ALL SELECT '2020-02', 2020, 2
  UNION ALL SELECT '2020-03', 2020, 3
  UNION ALL SELECT '2020-04', 2020, 4
  UNION ALL SELECT '2020-05', 2020, 5
  UNION ALL SELECT '2020-06', 2020, 6
  UNION ALL SELECT '2020-07', 2020, 7
  UNION ALL SELECT '2020-08', 2020, 8
  UNION ALL SELECT '2020-09', 2020, 9
  UNION ALL SELECT '2020-10', 2020, 10
  UNION ALL SELECT '2020-11', 2020, 11
  UNION ALL SELECT '2020-12', 2020, 12
  UNION ALL SELECT '2021-01', 2021, 1
  UNION ALL SELECT '2021-02', 2021, 2
  UNION ALL SELECT '2021-03', 2021, 3
  UNION ALL SELECT '2021-04', 2021, 4
  UNION ALL SELECT '2021-05', 2021, 5
  UNION ALL SELECT '2021-06', 2021, 6
  UNION ALL SELECT '2021-07', 2021, 7
  UNION ALL SELECT '2021-08', 2021, 8
  UNION ALL SELECT '2021-09', 2021, 9
  UNION ALL SELECT '2021-10', 2021, 10
  UNION ALL SELECT '2021-11', 2021, 11
  UNION ALL SELECT '2021-12', 2021, 12
  UNION ALL SELECT '2022-01', 2022, 1
  UNION ALL SELECT '2022-02', 2022, 2
  UNION ALL SELECT '2022-03', 2022, 3
  UNION ALL SELECT '2022-04', 2022, 4
  UNION ALL SELECT '2022-05', 2022, 5
  UNION ALL SELECT '2022-06', 2022, 6
  UNION ALL SELECT '2022-07', 2022, 7
  UNION ALL SELECT '2022-08', 2022, 8
  UNION ALL SELECT '2022-09', 2022, 9
  UNION ALL SELECT '2022-10', 2022, 10
  UNION ALL SELECT '2022-11', 2022, 11
  UNION ALL SELECT '2022-12', 2022, 12
) am
LEFT JOIN (
  -- 第一步的查询结果
  SELECT 
    SUBSTR(CAST(publication_date AS STRING), 1, 4) AS year,
    SUBSTR(CAST(publication_date AS STRING), 5, 2) AS month,
    COUNT(*) AS publication_count
  FROM PATENTS_PATENTS_PUBLICATIONS 
  WHERE country_code = 'US'
    AND publication_date BETWEEN 20080101 AND 20221231
    AND abstract_localized IS NOT NULL
    AND LOWER(CAST(abstract_localized AS STRING)) LIKE '%internet of things%'
  GROUP BY year, month
) ip ON am.year = CAST(ip.year AS INT) AND am.month = CAST(ip.month AS INT)
ORDER BY am.year, am.month;

-- 总统计：2008-2022年包含"internet of things"的美国专利总数
SELECT COUNT(*) AS total_iot_publications
FROM PATENTS_PATENTS_PUBLICATIONS 
WHERE country_code = 'US'
  AND publication_date BETWEEN 20080101 AND 20221231
  AND abstract_localized IS NOT NULL
  AND LOWER(CAST(abstract_localized AS STRING)) LIKE '%internet of things%';